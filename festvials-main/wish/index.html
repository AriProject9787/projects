<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Birthday Reminder</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2, h3 {
      text-align: center;
      color: #333;
    }
    input, button, label, select {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    button {
      background: #4CAF50;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    .link {
      text-align: center;
      margin-top: 10px;
      cursor: pointer;
      color: blue;
    }
    .birthday-card {
      background: #fff;
      margin: 8px 0;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .today-card {
      background: #e6ffea;
      border-left: 4px solid #4CAF50;
    }
    .countdown {
      margin-top: 6px;
      font-weight: 500;
      color: #444;
    }
    /* Navbar */
    .navbar {
      display: flex;
      justify-content: space-around;
      background: #4CAF50;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .navbar a {
      color: #fff;
      text-decoration: none;
      font-weight: bold;
    }
    .navbar a:hover {
      text-decoration: underline;
    }
    /* Dark theme */
    body.dark {
      background: #181818;
      color: #f0f0f0;
    }
    body.dark .container {
      background: #242424;
      color: #f0f0f0;
    }
    body.dark input, body.dark select {
      background: #333;
      color: #fff;
      border: 1px solid #555;
    }
    body.dark .birthday-card {
      background: #2d2d2d;
      color: #f0f0f0;
    }
    body.dark .navbar {
      background: #333;
    }
    footer {
      text-align: center;
      margin-top: 20px;
      font-size: 13px;
      color: #555;
    }
    body.dark footer {
      color: #aaa;
    }
  </style>
</head>
<body>
  <!-- Signup -->
  <div class="container" id="signupContainer" style="display:none;">
    <h2>Create Account</h2>
    <input type="text" id="signupUsername" placeholder="Username" />
    <input type="email" id="signupEmail" placeholder="Email" />
    <input type="password" id="signupPassword" placeholder="Password" />
    <input type="date" id="signupDob" placeholder="Date of Birth" />
    <select id="signupDobVisibility">
      <option value="private" selected>Private</option>
      <option value="public">Public</option>
    </select>
    
    <label>
      <center><input type="checkbox" id="termsCheckbox" /></center>
      <center>I agree to the <a href="terms.html" target="_blank">Terms and Conditions</a></center>
    </label>

    <button id="signupBtn">Sign Up</button>
    <div class="link" onclick="toggleView('login')">Already have an account? Login</div>
  </div>

  <!-- Login -->
  <div class="container" id="loginContainer">
    <h2>Login</h2>
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <button id="loginBtn">Login</button>
    <div class="link" onclick="toggleView('signup')">New user? Sign Up</div>
  </div>

  <!-- Dashboard -->
  <div class="container" id="dashboardContainer" style="display:none;">
    <!-- Navigation panel -->
    <div class="navbar">
      <a href="#">Home</a>
      <a href="about.html" target="_blank" >About</a>
      <a href="https://ariproject9787.github.io/portfolio/" target="_blank">Developer</a>
      <a href="terms.html" target="_blank">Terms</a>
      <a href="contact.html" target="_blank">Contact</a>
    </div>

    <h2 id="welcomeMsg">Dashboard</h2>
    <button id="themeToggle">ðŸŒ™ Toggle Theme</button>

    <h3>ðŸŽ‚ Today</h3>
    <div id="today"></div>
    <h3>ðŸ“… Upcoming</h3>
    <div id="upcoming"></div>
    <h3>âœ… Past</h3>
    <div id="past"></div>

    <h3>Add Birthday</h3>
    <input type="text" id="name" placeholder="Name" />
    <input type="date" id="dob" />
    <select id="dobVisibility">
      <option value="private" selected>Private</option>
      <option value="public">Public</option>
    </select>
    <button id="addBtn">Add Birthday</button>

    <button id="logoutBtn">Logout</button>
  </div>

  <footer>
    Â© <span id="year"></span> Arirama Selvam - <span id="todayDate"></span>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA5dtwCn09lEtrAOP3ih_Iq9YDFSKB181w",
      authDomain: "birthdaycountdown9787.firebaseapp.com",
      projectId: "birthdaycountdown9787",
      storageBucket: "birthdaycountdown9787.firebasestorage.app",
      messagingSenderId: "1057605732413",
      appId: "1:1057605732413:web:18768b4a6bb5a7c2f64254",
      measurementId: "G-M3914S92YP"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentUsername = null;
    let countdownIntervals = [];

    function clearCountdownIntervals() {
      countdownIntervals.forEach(id => clearInterval(id));
      countdownIntervals = [];
    }

    function toggleView(view) {
      document.getElementById("signupContainer").style.display = view === "signup" ? "block" : "none";
      document.getElementById("loginContainer").style.display = view === "login" ? "block" : "none";
    }
    window.toggleView = toggleView;
    toggleView("login");

    // Theme toggle
    document.getElementById("themeToggle").addEventListener("click", () => {
      document.body.classList.toggle("dark");
    });

    // Sign up
    document.getElementById("signupBtn").addEventListener("click", async () => {
      const username = document.getElementById("signupUsername").value;
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;
      const dob = document.getElementById("signupDob").value;
      const visibility = document.getElementById("signupDobVisibility").value;
      const termsChecked = document.getElementById("termsCheckbox").checked;

      if (!username || !email || !password || !dob) {
        alert("All fields are required");
        return;
      }
      if (!termsChecked) { alert("Please accept the Terms and Conditions"); return; }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        currentUser = userCredential.user;
        currentUsername = username;

        await addDoc(collection(db, "users"), {
          uid: currentUser.uid,
          username,
          dob,
          visibility
        });

        await addDoc(collection(db, "birthdays"), {
          uid: currentUser.uid,
          name: username,
          dob,
          visibility
        });

        showDashboard(username);
      } catch (error) {
        alert(error.message);
      }
    });

    // Login
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        currentUser = userCredential.user;
        showDashboard();
      } catch (error) {
        alert(error.message);
      }
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      currentUser = null;
      currentUsername = null;
      toggleView("login");
      document.getElementById("dashboardContainer").style.display = "none";
    });

    // Add birthday
    document.getElementById("addBtn").addEventListener("click", async () => {
      if (!currentUser) return;
      const name = document.getElementById("name").value;
      const dob = document.getElementById("dob").value;
      let visibility = "private";

      if (currentUsername === "admin") {
        visibility = document.getElementById("dobVisibility").value;
      }

      if (!name || !dob) { alert("Enter both name and date"); return; }

      await addDoc(collection(db, "birthdays"), {
        uid: currentUser.uid,
        name,
        dob,
        visibility
      });

      loadBirthdays();
    });

    // Load birthdays
    async function loadBirthdays() {
      if (!currentUser) return;
      const todayContainer = document.getElementById('today');
      const upcomingContainer = document.getElementById('upcoming');
      const pastContainer = document.getElementById('past');
      clearCountdownIntervals();
      todayContainer.innerHTML = "";
      upcomingContainer.innerHTML = "";
      pastContainer.innerHTML = "";

      const snapshot = await getDocs(collection(db, "birthdays"));
      const today = new Date();

      snapshot.forEach(docSnap => {
        const person = docSnap.data();
        if (person.visibility === "private" && person.uid !== currentUser.uid) return;

        const dob = new Date(person.dob);
        const thisYear = new Date(today.getFullYear(), dob.getMonth(), dob.getDate());
        const age = today.getFullYear() - dob.getFullYear();

        if (thisYear.toDateString() === today.toDateString()) {
          updateCard(person, todayContainer, age, thisYear);
        } else if (thisYear > today) {
          updateCard(person, upcomingContainer, age, thisYear);
        } else {
          updateCard(person, pastContainer, age, thisYear);
        }
      });
    }

    function updateCard(person, container, age, date) {
      const target = new Date(date);
      const card = document.createElement("div");
      card.className = "birthday-card";

      let dobDisplay = target.toDateString();
      let ageDisplay = `(${age} yrs)`;

      card.innerHTML = `<div><b>${person.name}</b> ðŸŽ‚ ${ageDisplay} - ${dobDisplay}</div><div class="countdown" aria-live="polite"></div>`;
      container.appendChild(card);

      const countdownEl = card.querySelector('.countdown');
      function tick() {
        const now = new Date();
        const dist = target - now;
        if (dist > 0) {
          const days = Math.floor(dist / (1000 * 60 * 60 * 24));
          const hours = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutes = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((dist % (1000 * 60)) / 1000);
          countdownEl.textContent = `â³ ${days}d ${hours}h ${minutes}m ${seconds}s left`;
          card.classList.remove('today-card');
        } else if (target.toDateString() === now.toDateString()) {
          countdownEl.textContent = `ðŸŽ‰ Today!`;
          card.classList.add('today-card');
        } else {
          countdownEl.textContent = `âœ… Already celebrated this year`;
          card.classList.remove('today-card');
        }
      }
      tick();
      countdownIntervals.push(setInterval(tick, 1000));
    }

    async function showDashboard(username=null) {
      document.getElementById("signupContainer").style.display = "none";
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("dashboardContainer").style.display = "block";

      if (currentUser) {
        const usersSnapshot = await getDocs(collection(db, "users"));
        const userDoc = usersSnapshot.docs.find(doc => doc.data().uid === currentUser.uid);
        if (userDoc) {
          const data = userDoc.data();
          currentUsername = data.username;
          document.getElementById("welcomeMsg").textContent = `ðŸ‘‹ Welcome, ${data.username}!`;
          document.getElementById("name").value = data.username || "";
          document.getElementById("dob").value = data.dob || "";

          // Show/hide visibility option based on admin
          if (data.username === "admin") {
            document.getElementById("dobVisibility").style.display = "block";
          } else {
            document.getElementById("dobVisibility").style.display = "none";
          }
        } else if (username) {
          currentUsername = username;
          document.getElementById("welcomeMsg").textContent = `ðŸ‘‹ Welcome, ${username}!`;
        }
      }

      loadBirthdays();
    }

    // Footer date
    document.getElementById("year").textContent = new Date().getFullYear();
    document.getElementById("todayDate").textContent = new Date().toDateString();
  </script>
</body>
</html>
